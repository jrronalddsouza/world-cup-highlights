"use strict";

const {
  parse
} = require('url');

const axios = require('axios');
/**
 * Emulates Layer0 image optimizer. To be used in local production mode
 * when the framework does not provide it's own image optimization (for example, Next.js only provides image optimization in development).
 * Some day we should port the actual image optimizer code here, but for now we just return the original image so that images show up.
 * @param port The port to bind to
 */


module.exports = async function serveOptimizedImage(req, res) {
  const url = parse(req.url, true);

  try {
    var _process$env$LAYER0_I, _process$env$LAYER0_I2;

    const protocol = req.secure ? 'https://' : 'http://';
    const host = (_process$env$LAYER0_I = process.env.LAYER0_IMAGE_OPTIMIZER_HOST) !== null && _process$env$LAYER0_I !== void 0 ? _process$env$LAYER0_I : '127.0.0.1';
    const port = (_process$env$LAYER0_I2 = process.env.LAYER0_IMAGE_OPTIMIZER_PORT) !== null && _process$env$LAYER0_I2 !== void 0 ? _process$env$LAYER0_I2 : '3000';
    const absoluteUrl = new URL(url.query.url, `${protocol}${host}:${port}`);
    const upstreamRes = await axios.get(absoluteUrl.toString(), {
      responseType: 'arraybuffer'
    });
    res.writeHead(upstreamRes.status, upstreamRes.statusText, upstreamRes.headers);
    res.end(Buffer.from(upstreamRes.data, 'binary'));
  } catch (e) {
    console.error(e);
    res.writeHead(500, 'Internal Server Error');
    res.end();
  }
};